# Build Jellyfish for Windows (zip). Run on GitHub's Windows runner so you don't need a Windows PC.
# Trigger: Actions tab → "Build Windows" → Run workflow. Optionally set release tag to upload zip to that release.
name: Build Windows

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to upload zip to (e.g. v1.0.0). Leave empty to only get the artifact.'
        required: false
        type: string

jobs:
  build:
    runs-on: windows-latest
    env:
      CI: true
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Setup 7-Zip
        uses: milliewalky/setup-7-zip@v2
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Build (shared, core, memory, chat, action)
        run: pnpm build

      - name: Build Vision (Next.js)
        run: pnpm --filter @jellyfish/vision run build

      - name: Package for Windows
        shell: pwsh
        run: |
          Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass -Force
          & .\packaging\windows\build.ps1
          if (-not (Test-Path "packaging\out\windows\Jellyfish-win-x64.zip")) {
            Write-Error "Zip was not created"
            Get-ChildItem -Path "packaging\out\windows" -Recurse -Depth 1 | Format-Table Name, Length
            exit 1
          }
          Get-Item "packaging\out\windows\Jellyfish-win-x64.zip" | Select-Object Name, @{N='SizeMB';E={[math]::Round($_.Length/1MB,2)}}

      - name: Upload Windows zip
        uses: actions/upload-artifact@v4
        with:
          name: Jellyfish-win-x64
          path: packaging/out/windows/Jellyfish-win-x64.zip

      - name: Upload to release
        if: inputs.release_tag != ''
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload "${{ inputs.release_tag }}" "packaging/out/windows/Jellyfish-win-x64.zip" --repo ${{ github.repository }} --clobber
